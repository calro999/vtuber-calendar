<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš†ã§ä½œã‚‹Vå›³é‘‘ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <style>
        :root { --main-pink: #ff85a2; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fff5f7; color: #444; }
        .nav-btn { padding: 8px 16px; border-radius: 999px; font-weight: bold; transition: 0.3s; background: white; color: var(--main-pink); border: 2px solid var(--main-pink); white-space: nowrap; }
        .nav-btn.active { background: var(--main-pink); color: white; }
        
        /* é…ä¿¡ã‚«ãƒ¼ãƒ‰ï¼šå…ƒã®ã‚µã‚¤ã‚ºæ„Ÿ */
        .stream-card { background: white; border-radius: 15px; border: 1px solid #ffdeeb; height: 450px; display: flex; flex-direction: column; overflow: hidden; margin-bottom: 15px; }
        .stream-iframe-wrap { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .stream-iframe-wrap iframe { width: 100%; height: 500px; transform: scale(0.9); transform-origin: top center; border: none; }

        /* ä»Šæ—¥ã®ãŠã¯Vï¼šè¢«ã‚Šé˜²æ­¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #ohvStack { position: relative; height: 420px; width: 100%; max-width: 320px; margin: 0 auto; }
        .swipe-card { position: absolute; width: 100%; height: 100%; background: white; border-radius: 15px; border: 1px solid #ffdeeb; transition: transform 0.4s ease; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* è©•ä¾¡ãƒˆãƒ¬ã‚¤ï¼šæœ€ä¸‹éƒ¨ã«å›ºå®š */
        #tagTray { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 3px solid var(--main-pink); padding: 15px; z-index: 100; transform: translateY(100%); transition: 0.3s; }
        #tagTray.open { transform: translateY(0); }
        .tag-btn { padding: 10px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; border: 1px solid #eee; text-align: center; cursor: pointer; background: #fffcfd; }

        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="max-w-2xl mx-auto px-4 pb-32">
        <header class="text-center py-6">
            <h1 class="text-2xl font-bold text-[#ff85a2] mb-4">ğŸ€ çš†ã§ä½œã‚‹Vå›³é‘‘ï¼ ğŸ€</h1>
            <nav class="flex justify-center gap-2 overflow-x-auto no-scrollbar">
                <button id="tabMain" class="nav-btn active" onclick="switchTab('main')">é…ä¿¡ä¸€è¦§</button>
                <button id="tabTimeline" class="nav-btn" onclick="switchTab('timeline')">æ™‚é–“å‰²</button>
                <button id="tabOhv" class="nav-btn" onclick="switchTab('ohv')">ä»Šæ—¥ã®ãŠã¯V</button>
                <button id="tabZukan" class="nav-btn" onclick="switchTab('zukan')">çš†ã§ä½œã‚‹Vå›³é‘‘</button>
            </nav>
        </header>

        <section id="formArea" class="bg-white p-4 rounded-xl mb-6 shadow-sm border border-pink-50">
            <form id="scheduleForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <input type="text" id="vName" placeholder="é…ä¿¡è€…å" class="p-2 border rounded" required>
                <input type="url" id="tweetUrl" placeholder="Xï¼ˆæ—§Twitterï¼‰ãƒã‚¹ãƒˆURL" class="p-2 border rounded" required>
                <div class="flex gap-2">
                    <input type="date" id="vDate" class="p-2 border rounded flex-1">
                    <input type="time" id="vTime" class="p-2 border rounded flex-1">
                </div>
                <div class="flex gap-2">
                    <select id="vGenre" class="p-2 border rounded flex-1">
                        <option value="é›‘è«‡">é›‘è«‡</option><option value="ã‚²ãƒ¼ãƒ ">ã‚²ãƒ¼ãƒ </option><option value="æ­Œæ ">æ­Œæ </option><option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <select id="vType" class="p-2 border rounded flex-1">
                        <option value="é…ä¿¡">é…ä¿¡äºˆå®š</option><option value="ãŠã¯V">ãŠã¯V</option>
                    </select>
                </div>
                <button type="submit" class="bg-[#ff85a2] text-white rounded py-2 font-bold md:col-span-2">ç™»éŒ²ã™ã‚‹</button>
            </form>
        </section>

        <main id="viewMain"><div id="streamList"></div></main>
        <section id="viewTimeline" class="hidden"><div id="timelineContainer" class="bg-white p-4 rounded-xl"></div></section>
        <section id="viewOhv" class="hidden flex flex-col items-center"><div id="ohvStack"></div></section>
        <section id="viewZukan" class="hidden"><div id="zukanList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></section>
    </div>

    <div id="tagTray">
        <p class="text-center font-bold text-pink-500 mb-3 text-sm">å¿œæ´ã‚¿ã‚°ã‚’é€ã‚‹ï¼ˆä»»æ„ï¼‰ âœ¨</p>
        <div class="grid grid-cols-3 gap-2">
            <button class="tag-btn" onclick="rateV('ã‚«ãƒ¯ãƒœ')">ã‚«ãƒ¯ãƒœ</button>
            <button class="tag-btn" onclick="rateV('ã‚¤ã‚±ãƒœ')">ã‚¤ã‚±ãƒœ</button>
            <button class="tag-btn" onclick="rateV('ãŠå§‰ã•ã‚“')">ãŠå§‰ã•ã‚“</button>
            <button class="tag-btn" onclick="rateV('è³‘ã‚„ã‹')">è³‘ã‚„ã‹</button>
            <button class="tag-btn" onclick="rateV('ç™’ã‚„ã—')">ç™’ã‚„ã—</button>
            <button class="tag-btn bg-gray-100" onclick="nextCard()">ãƒ‘ã‚¹ ğŸ’¨</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw5zrtCgsZDoX3dZ6Dvup_X3Ej2-GNO5Gr8UzLUsTEi8idPnW--1bU4bZ4KcSAMiZcH/exec";
        let allData = [];
        let currentOhvIndex = 0;

        async function fetchData() {
            const res = await fetch(`${GAS_URL}?t=${Date.now()}`);
            allData = await res.json();
            renderAll();
            if(window.twttr) twttr.widgets.load();
        }

        function renderAll() {
            const today = new Date().toLocaleDateString('ja-JP', {timeZone: 'Asia/Tokyo'}).replace(/\//g, '-');
            
            // é…ä¿¡ä¸€è¦§
            const list = document.getElementById('streamList');
            const streams = allData.filter(d => d.type === 'é…ä¿¡' && d.date.replace(/\//g, '-') === today).sort((a,b) => a.time.localeCompare(b.time));
            list.innerHTML = streams.map(d => `
                <div class="stream-card">
                    <div class="p-2 bg-pink-400 text-white text-center font-bold text-sm">${d.time} | ${d.name}</div>
                    <div class="stream-iframe-wrap"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${d.url.split('/status/')[1]?.split('?')[0]}"></iframe></div>
                </div>`).join('') || "<p class='text-center text-gray-400 py-10'>æœ¬æ—¥ã®é…ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>";

            // æ™‚é–“å‰²
            const timeline = document.getElementById('timelineContainer');
            timeline.innerHTML = "";
            for(let h=0; h<24; h++) {
                const hourItems = streams.filter(d => parseInt(d.time.split(':')[0]) === h);
                timeline.innerHTML += `<div class="flex border-b py-2"><div class="w-12 font-bold text-pink-300">${h}:00</div><div class="flex-1 flex flex-wrap gap-2">${hourItems.map(i => `<span class="bg-pink-50 text-pink-600 px-2 py-1 rounded-full text-xs font-bold">${i.name}</span>`).join('')}</div></div>`;
            }

            // ãŠã¯Vï¼ˆæœªè©•ä¾¡ã®ã¿ï¼‰
            const stack = document.getElementById('ohvStack');
            const ohvs = allData.filter(d => d.type === 'ãŠã¯V' && !d.voice).reverse();
            stack.innerHTML = ohvs.map((d, i) => `
                <div class="swipe-card" style="z-index:${100-i}">
                    <div class="p-2 border-b text-center font-bold text-pink-500">${d.name}</div>
                    <div class="stream-iframe-wrap"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${d.url.split('/status/')[1]?.split('?')[0]}"></iframe></div>
                </div>`).join('') || "<p class='text-center py-20 text-gray-400'>æ–°ã—ã„ãŠã¯Vã¯ã‚ã‚Šã¾ã›ã‚“</p>";

            // å›³é‘‘
            const zukan = document.getElementById('zukanList');
            zukan.innerHTML = allData.filter(d => d.type === 'ãŠã¯V' && d.voice).map(d => `
                <div class="stream-card">
                    <div class="p-2 bg-pink-100 text-pink-600 text-center font-bold text-xs">${d.name}</div>
                    <div class="stream-iframe-wrap"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${d.url.split('/status/')[1]?.split('?')[0]}"></iframe></div>
                    <div class="p-2 flex gap-2 justify-center border-t bg-pink-50">
                        <span class="bg-white px-3 py-1 rounded-full text-[10px] font-bold text-pink-500">#${d.voice}</span>
                        <span class="bg-white px-3 py-1 rounded-full text-[10px] font-bold text-blue-500">#${d.atm}</span>
                    </div>
                </div>`).join('');
        }

        function switchTab(t) {
            ['viewMain', 'viewTimeline', 'viewOhv', 'viewZukan'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            
            const ohvs = allData.filter(d => d.type === 'ãŠã¯V' && !d.voice);
            document.getElementById('tagTray').classList.toggle('open', t === 'ohv' && ohvs.length > 0);
        }

        async function rateV(voice) {
            const ohvs = allData.filter(d => d.type === 'ãŠã¯V' && !d.voice).reverse();
            const target = ohvs[0];
            nextCard();
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "rate", url: target.url, voice: voice, atm: "å¿œæ´" }) });
            fetchData();
        }

        function nextCard() {
            const cards = document.querySelectorAll('.swipe-card');
            if(cards[0]) {
                cards[0].style.transform = "translateX(150%) rotate(20deg)";
                setTimeout(() => { cards[0].remove(); if(document.querySelectorAll('.swipe-card').length === 0) switchTab('ohv'); }, 400);
            }
        }

        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('vName').value,
                url: document.getElementById('tweetUrl').value,
                date: document.getElementById('vDate').value,
                time: document.getElementById('vTime').value,
                genre: document.getElementById('vGenre').value,
                type: document.getElementById('vType').value
            };
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            alert("ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼");
            fetchData();
        };

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('vDate').value = today;
            fetchData();
        };
    </script>
</body>
</html>
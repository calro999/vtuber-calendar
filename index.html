<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTuberç·åˆç•ªçµ„è¡¨ğŸ€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fff5f7; }
        .pink-gradient { background: linear-gradient(135deg, #ffdeeb 0%, #ffb7c5 100%); }
        .glass-morphism { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 2px solid #ffb7c5; }
        .nav-btn { cursor: pointer; padding: 8px 18px; border-radius: 999px; font-weight: bold; transition: 0.3s; background: white; color: #ffb7c5; border: 2px solid #ffb7c5; font-size: 0.9rem; }
        .nav-btn.active { background: #ffb7c5; color: white; }
        .hidden { display: none; }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ */
        .filter-btn { padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; border: 1px solid #ffdeeb; background: white; cursor: pointer; }
        .filter-btn.active { background: #ff85a2; color: white; border-color: #ff85a2; }

        /* ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼šå¯è¦–æ€§é‡è¦–ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¨­è¨ˆ */
        .tweet-card { background: white; border-radius: 18px; box-shadow: 0 6px 15px rgba(255,183,197,0.15); border: 1px solid #ffdeeb; overflow: hidden; display: flex; flex-direction: column; height: 520px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #fffafb; border-bottom: 1px solid #fff0f3; flex-shrink: 0; }
        
        /* åŸ‹ã‚è¾¼ã¿ã‚¨ãƒªã‚¢ï¼šé«˜ã•ã‚’æŠ‘ãˆã¦åã¾ã‚Šã‚’è‰¯ãã™ã‚‹ */
        .tweet-wrapper { flex: 1; overflow-y: auto; background: #fff; display: flex; justify-content: center; }
        .tweet-iframe { width: 100%; height: 600px; border: none; transform: scale(0.9); transform-origin: top center; }

        /* ãŠã¯Vï¼šå¼•ç”¨å¯¾å¿œã§ã•ã‚‰ã«ã‚¹ã‚±ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ */
        .ohv-iframe { width: 100%; height: 800px; border: none; transform: scale(0.8); transform-origin: top center; }
        
        .cheer-btn { width: 100%; padding: 10px; background: #1da1f2; color: white; font-weight: bold; text-align: center; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 6px; flex-shrink: 0; }

        .timeline-btn { display: inline-flex; align-items: center; gap: 4px; background: white; padding: 4px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: bold; margin: 2px; border: 2px solid; }
        .btn-chat { border-color: #ffb7c5; color: #ff85a2; }
        .btn-game { border-color: #a0e1ff; color: #40a9ff; }
        .btn-song { border-color: #c2ffb7; color: #4ecb3d; }
        .btn-etc  { border-color: #ffe0b7; color: #ff9f40; }

        .genre-tag { font-size: 0.65rem; background: #fff0f3; color: #ff85a2; padding: 1px 6px; border-radius: 5px; }
        .gender-tag { font-size: 0.65rem; padding: 1px 5px; border-radius: 4px; font-weight: bold; }
        .tag-female { background: #ffebee; color: #ff4081; }
        .tag-male { background: #e3f2fd; color: #2196f3; }
        .tag-other { background: #f5f5f5; color: #757575; }

        .date-selector-btn { padding: 6px 14px; border-radius: 999px; font-size: 0.8rem; border: 2px solid #ffb7c5; background: white; color: #ffb7c5; font-weight: bold; }
        .date-selector-btn.active { background: #ffb7c5; color: white; }
        
        input, select { font-size: 13px !important; height: 38px; border-radius: 10px !important; }
        .form-label { font-size: 11px; font-weight: bold; color: #ff85a2; margin-bottom: 2px; display: block; }
    </style>
</head>
<body class="text-gray-700">

    <div class="max-w-6xl mx-auto p-3 md:p-6">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-[#ff85a2] mb-4 drop-shadow-sm">ğŸ€ VTuberç·åˆç•ªçµ„è¡¨ ğŸ€</h1>
            <div class="flex justify-center gap-2 flex-wrap">
                <button id="tabMain" class="nav-btn active" onclick="switchTab('main')">âœ¨ é…ä¿¡ä¸€è¦§</button>
                <button id="tabCalendar" class="nav-btn" onclick="switchTab('calendar')">ğŸ“… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
                <button id="tabOhv" class="nav-btn" onclick="switchTab('ohv')">â˜€ï¸ ãŠã¯V</button>
            </div>
        </header>

        <section id="formStream" class="glass-morphism p-4 rounded-2xl mb-6 shadow-sm">
            <span class="form-label">ğŸ“º é…ä¿¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²</span>
            <form id="scheduleForm" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                <input type="text" id="vtuberName" placeholder="é…ä¿¡è€…å" class="p-2 border-2 border-[#ffdeeb] outline-none" required>
                <div class="flex"><select id="month" class="border-y-2 border-l-2 border-[#ffdeeb] bg-white w-full"></select><select id="day" class="border-2 border-[#ffdeeb] bg-white w-full"></select></div>
                <input type="time" id="startTime" class="p-2 border-2 border-[#ffdeeb] bg-white" required>
                <select id="genre" class="p-2 border-2 border-[#ffdeeb] bg-white"><option value="é›‘è«‡">ğŸ’¬ é›‘è«‡</option><option value="ã‚²ãƒ¼ãƒ ">ğŸ® ã‚²ãƒ¼ãƒ </option><option value="æ­Œæ ">ğŸ¤ æ­Œæ </option><option value="ãã®ä»–">ğŸ’¡ ãã®ä»–</option></select>
                <select id="gender" class="p-2 border-2 border-[#ffdeeb] bg-white w-full"><option value="â™€">â™€ å¥³å­</option><option value="â™‚">â™‚ ç”·å­</option><option value="ãã®ä»–">â” ä»–</option></select>
                <input type="url" id="tweetUrl" placeholder="URL" class="p-2 border-2 border-[#ffdeeb] col-span-1 md:col-span-1 outline-none" required>
                <button type="submit" class="pink-gradient text-white font-bold py-1 rounded-xl shadow-sm text-sm">ç™»éŒ²ï¼</button>
            </form>
        </section>

        <section id="formOhv" class="glass-morphism p-4 rounded-2xl mb-6 shadow-sm hidden">
            <span class="form-label">â˜€ï¸ ãŠã¯ã‚ˆã†VTuberç™»éŒ²</span>
            <form id="ohvForm" class="flex flex-wrap gap-2">
                <input type="text" id="ohvName" placeholder="ãŠåå‰" class="flex-1 min-w-[120px] p-2 border-2 border-[#ffdeeb] outline-none" required>
                <select id="ohvGender" class="w-20 border-2 border-[#ffdeeb] bg-white"><option value="â™€">â™€ å¥³å­</option><option value="â™‚">â™‚ ç”·å­</option><option value="ãã®ä»–">â” ä»–</option></select>
                <input type="url" id="ohvUrl" placeholder="ãƒã‚¹ãƒˆã®URLã‚’ãƒšãƒ¼ã‚¹ãƒˆ" class="flex-[2] min-w-[200px] p-2 border-2 border-[#ffdeeb] outline-none" required>
                <button type="submit" class="bg-orange-400 hover:bg-orange-500 text-white font-bold px-6 py-1 rounded-xl shadow-sm text-sm">æŠ•ç¨¿ï¼</button>
            </form>
        </section>

        <div id="filterBar" class="mb-3 flex justify-end gap-2 items-center">
            <span class="text-[10px] font-bold text-[#ffb7c5] uppercase tracking-wider">Filter:</span>
            <button class="filter-btn active" data-gender="All" onclick="setGenderFilter('All')">ALL</button>
            <button class="filter-btn" data-gender="â™€" onclick="setGenderFilter('â™€')">â™€</button>
            <button class="filter-btn" data-gender="â™‚" onclick="setGenderFilter('â™‚')">â™‚</button>
        </div>

        <main id="viewMain"><div id="upcomingList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></main>
        <section id="viewCalendar" class="hidden"><div class="bg-white p-4 rounded-[25px] shadow-sm border-2 border-[#ffdeeb]"><div id="dateSelector" class="flex justify-center gap-2 mb-4 flex-wrap"></div><div id="calendarContainer" class="space-y-0"></div></div></section>
        <section id="viewOhv" class="hidden"><div id="ohvList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></section>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw5zrtCgsZDoX3dZ6Dvup_X3Ej2-GNO5Gr8UzLUsTEi8idPnW--1bU4bZ4KcSAMiZcH/exec"; 
        let allSchedules = [];
        let currentGenderFilter = "All";

        function getJSTDateStr(offset = 0) {
            const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
            d.setDate(d.getDate() + offset);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        let selectedTimelineDate = getJSTDateStr(0);

        window.onload = () => {
            const mSel = document.getElementById('month');
            const dSel = document.getElementById('day');
            for(let i=1; i<=12; i++) mSel.innerHTML += `<option value="${String(i).padStart(2,'0')}">${i}æœˆ</option>`;
            for(let i=1; i<=31; i++) dSel.innerHTML += `<option value="${String(i).padStart(2,'0')}">${i}æ—¥</option>`;
            const today = getJSTDateStr(0).split('-');
            mSel.value = today[1]; dSel.value = today[2];
            setupDateSelector();
            fetchSchedules();
        };

        function setupDateSelector() {
            const selector = document.getElementById('dateSelector');
            if(!selector) return;
            selector.innerHTML = '';
            ["ä»Šæ—¥", "æ˜æ—¥", "æ˜å¾Œæ—¥"].forEach((label, i) => {
                const ds = getJSTDateStr(i);
                const btn = document.createElement('button');
                btn.className = `date-selector-btn ${ds === selectedTimelineDate ? 'active' : ''}`;
                btn.innerText = `${label}(${ds.slice(5).replace('-','/')})`;
                btn.onclick = () => { selectedTimelineDate = ds; setupDateSelector(); renderAll(); };
                selector.appendChild(btn);
            });
        }

        function setGenderFilter(gender) {
            currentGenderFilter = gender;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.gender === gender));
            renderAll();
        }

        function parseClean(item) {
            const sDate = String(item.date || "");
            const sTime = String(item.time || "");
            let y = "2026", m = "01", d = "15";
            const dm = sDate.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
            if(dm) { [y, m, d] = [dm[1], dm[2].padStart(2,'0'), dm[3].padStart(2,'0')]; }
            let hh = "00", mm = "00";
            const tm = sTime.match(/(\d{1,2}):(\d{1,2})/);
            if(tm) { [hh, mm] = [tm[1].padStart(2,'0'), tm[2].padStart(2,'0')]; }
            return { date: `${y}-${m}-${d}`, time: `${hh}:${mm}`, name: item.name || "ä¸æ˜", genre: item.genre || "ãã®ä»–", url: item.url || "#", gender: item.gender || "â™€", type: item.type || "é…ä¿¡" };
        }

        async function fetchSchedules() {
            try {
                const res = await fetch(GAS_URL);
                const json = await res.json();
                const yesterday = getJSTDateStr(-1);
                allSchedules = json.map(i => parseClean(i)).filter(i => i.date >= yesterday);
                renderAll();
            } catch (e) { console.error(e); }
        }

        function renderAll() {
            const listEl = document.getElementById('upcomingList');
            const calEl = document.getElementById('calendarContainer');
            const ohvEl = document.getElementById('ohvList');
            listEl.innerHTML = ''; calEl.innerHTML = ''; ohvEl.innerHTML = '';

            const boxes = {};
            for (let i = 0; i < 24; i++) {
                const row = document.createElement('div');
                row.className = 'flex border-b border-pink-50 min-h-[40px] items-center';
                row.innerHTML = `<div class="w-12 font-bold text-[#ffb7c5] text-center text-[10px]">${String(i).padStart(2,'0')}:00</div><div id="h-box-${i}" class="flex-1 flex flex-wrap gap-1 px-3 py-1"></div>`;
                calEl.appendChild(row);
                boxes[i] = row.querySelector(`#h-box-${i}`);
            }

            const streamItems = allSchedules.filter(i => i.type === "é…ä¿¡").sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
            const ohvItems = allSchedules.filter(i => i.type === "ãŠã¯V").sort((a,b) => (b.date+b.time).localeCompare(a.date+a.time));

            const renderCard = (item) => {
                if (currentGenderFilter !== "All" && item.gender !== currentGenderFilter) return null;
                const tweetId = item.url.split('/status/')[1]?.split('?')[0];
                const gTag = `<span class="gender-tag ${item.gender==='â™€'?'tag-female':item.gender==='â™‚'?'tag-male':'tag-other'}">${item.gender}</span>`;
                const isOhv = item.type === 'ãŠã¯V';
                
                return `
                    <div class="tweet-card">
                        <div class="card-header">
                            <div class="flex items-center gap-2">
                                <span class="text-[#ff85a2] font-bold text-[13px]">â° ${item.date.slice(5).replace('-','/')} ${isOhv?'â˜€ï¸':item.time}</span>
                                ${gTag}
                                <span class="text-gray-700 font-bold text-[13px]">| ${item.name}</span>
                            </div>
                            ${isOhv?'':`<span class="genre-tag">${item.genre}</span>`}
                        </div>
                        <div class="tweet-wrapper">
                            <iframe class="${isOhv?'ohv-iframe':'tweet-iframe'}" src="https://platform.twitter.com/embed/Tweet.html?id=${tweetId}"></iframe>
                        </div>
                        <a href="${item.url}" target="_blank" class="cheer-btn">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            Xã§ç›´æ¥å¿œæ´
                        </a>
                    </div>
                `;
            };

            streamItems.forEach(item => {
                const html = renderCard(item);
                if(html) {
                    listEl.innerHTML += html;
                    if (item.date === selectedTimelineDate) {
                        const h = parseInt(item.time.split(':')[0]);
                        if (boxes[h]) {
                            const gClass = item.genre.includes("é›‘è«‡") ? "btn-chat" : item.genre.includes("ã‚²ãƒ¼ãƒ ") ? "btn-game" : item.genre.includes("æ­Œæ ") ? "btn-song" : "btn-etc";
                            const btn = document.createElement('button');
                            btn.className = `timeline-btn ${gClass}`;
                            btn.innerHTML = `<span class="opacity-60 text-[9px]">${item.time}</span><span>${item.gender}${item.name}</span>`;
                            btn.onclick = () => window.open(item.url, '_blank');
                            boxes[h].appendChild(btn);
                        }
                    }
                }
            });

            ohvItems.forEach(item => {
                const html = renderCard(item);
                if(html) ohvEl.innerHTML += html;
            });
        }

        function switchTab(tab) {
            document.getElementById('viewMain').classList.toggle('hidden', tab !== 'main');
            document.getElementById('viewCalendar').classList.toggle('hidden', tab !== 'calendar');
            document.getElementById('viewOhv').classList.toggle('hidden', tab !== 'ohv');
            document.getElementById('tabMain').classList.toggle('active', tab === 'main');
            document.getElementById('tabCalendar').classList.toggle('active', tab === 'calendar');
            document.getElementById('tabOhv').classList.toggle('active', tab === 'ohv');
            document.getElementById('formStream').classList.toggle('hidden', tab === 'ohv');
            document.getElementById('formOhv').classList.toggle('hidden', tab !== 'ohv');
        }

        async function submitData(data) {
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            alert("ç™»éŒ²å®Œäº†ï¼");
            fetchSchedules();
        }

        document.getElementById('scheduleForm').onsubmit = (e) => {
            e.preventDefault();
            submitData({
                name: document.getElementById('vtuberName').value,
                date: `2026-${document.getElementById('month').value}-${document.getElementById('day').value}`,
                time: document.getElementById('startTime').value,
                genre: document.getElementById('genre').value,
                url: document.getElementById('tweetUrl').value,
                gender: document.getElementById('gender').value,
                type: "é…ä¿¡"
            });
        };

        document.getElementById('ohvForm').onsubmit = (e) => {
            e.preventDefault();
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
            submitData({
                name: document.getElementById('ohvName').value,
                date: getJSTDateStr(0),
                time: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
                genre: "ãŠã¯V",
                url: document.getElementById('ohvUrl').value,
                gender: document.getElementById('ohvGender').value,
                type: "ãŠã¯V"
            });
            document.getElementById('ohvUrl').value = "";
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš†ã§ä½œã‚‹Vå›³é‘‘ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <style>
        :root { --v-pink: #ff85a2; --v-blue: #0095ff; --v-orange: #ff9900; --v-purple: #a855f7; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fff8f9; color: #333; margin: 0; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‹ã¤é«˜æ©Ÿèƒ½ */
        header { background: white; border-bottom: 2px solid #ffeff2; position: sticky; top: 0; z-index: 150; padding: 10px 0; }
        .nav-bar { display: flex; gap: 6px; padding: 0 12px; overflow-x: auto; margin-top: 10px; }
        .nav-btn { flex-shrink: 0; padding: 6px 14px; border-radius: 999px; font-size: 0.8rem; font-weight: bold; color: var(--v-pink); background: white; border: 2px solid var(--v-pink); }
        .nav-btn.active { background: var(--v-pink); color: white; box-shadow: 0 4px 10px rgba(255,133,162,0.2); }

        /* ç™»éŒ²ãƒœã‚¿ãƒ³ï¼šå³ä¸Šã«é…ç½® */
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; }
        .quick-add { display: flex; gap: 8px; }
        .add-icon-btn { background: var(--v-pink); color: white; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 8px; }

        /* é…ä¿¡ã‚«ãƒ¼ãƒ‰ï¼šä¸€ç”»é¢ã§ã—ã£ã‹ã‚Šè¦‹ãˆã‚‹ã‚µã‚¤ã‚º */
        .stream-card { background: white; border-radius: 20px; border: 1px solid #ffdeeb; height: 460px; display: flex; flex-direction: column; margin-bottom: 20px; box-shadow: 0 6px 15px rgba(0,0,0,0.03); }
        .card-label { padding: 8px; text-align: center; color: white; font-weight: bold; font-size: 0.8rem; }
        .iframe-wrap { flex: 1; overflow-y: auto; background: white; position: relative; }
        .iframe-wrap iframe { width: 100%; height: 550px; transform: scale(0.98); transform-origin: top center; border: none; }
        .x-link { padding: 12px; text-align: center; color: white; font-weight: bold; font-size: 0.85rem; text-decoration: none; display: block; }

        /* ä»Šæ—¥ã®ãŠã¯Vï¼šTinderé¢¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        #ohvStack { position: relative; height: 460px; width: 95%; max-width: 360px; margin: 15px auto; }
        .v-card { position: absolute; width: 100%; height: 100%; background: white; border-radius: 24px; border: 2px solid #ffdeeb; box-shadow: 0 15px 35px rgba(0,0,0,0.1); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s; overflow: hidden; }
        .v-card-top { padding: 10px; text-align: center; font-weight: bold; color: var(--v-orange); border-bottom: 1px solid #fff0f3; }

        /* å¿œæ´ã‚¿ã‚°ãƒˆãƒ¬ã‚¤ï¼šç”»é¢ä¸‹éƒ¨ã«å¸¸é§ï¼ˆãŠã¯Vã®ã¿ï¼‰ */
        .cheer-tray { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 12px 28px; border-top: 3px solid var(--v-pink); display: flex; gap: 8px; overflow-x: auto; z-index: 200; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 24px 24px 0 0; }
        .cheer-tray.open { transform: translateY(0); }
        .tag-btn { flex-shrink: 0; padding: 10px 16px; background: white; border: 2px solid var(--v-pink); color: var(--v-pink); border-radius: 14px; font-weight: bold; font-size: 0.8rem; }

        /* å›³é‘‘ï¼š2åˆ—ã‚°ãƒªãƒƒãƒ‰ */
        .zukan-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding-bottom: 20px; }
        .zukan-card { background: white; border-radius: 18px; border: 1px solid #ffdeeb; height: 340px; display: flex; flex-direction: column; overflow: hidden; }
        .zukan-tags { padding: 8px; display: flex; flex-wrap: wrap; gap: 4px; border-top: 1px solid #fff0f3; background: #fffcfd; }
        .tag-badge { font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 6px; }

        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .cat-é›‘è«‡ { background: var(--v-blue); } .cat-ã‚²ãƒ¼ãƒ  { background: var(--v-orange); } .cat-æ­Œæ  { background: var(--v-pink); } .cat-ãã®ä»– { background: var(--v-purple); }
    </style>
</head>
<body class="pb-24">

    <header>
        <div class="header-top">
            <h1 class="text-lg font-black text-[#ff85a2]">çš†ã§ä½œã‚‹Vå›³é‘‘ï¼</h1>
            <div class="quick-add">
                <button onclick="showForm('stream')" class="add-icon-btn">ï¼‹é…ä¿¡</button>
                <button onclick="showForm('ohv')" class="add-icon-btn">ï¼‹ãŠã¯V</button>
            </div>
        </div>
        <nav class="nav-bar no-scrollbar">
            <button id="tabMain" class="nav-btn active" onclick="switchTab('main')">é…ä¿¡ä¸€è¦§</button>
            <button id="tabTimeline" class="nav-btn" onclick="switchTab('timeline')">æ™‚é–“å‰²</button>
            <button id="tabOhv" class="nav-btn" onclick="switchTab('ohv')">ä»Šæ—¥ã®ãŠã¯V</button>
            <button id="tabZukan" class="nav-btn" onclick="switchTab('zukan')">å›³é‘‘</button>
        </nav>
    </header>

    <div id="modalForm" class="hidden fixed inset-0 bg-black/60 z-[300] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 relative">
            <button onclick="hideForm()" class="absolute top-5 right-5 text-gray-400 text-2xl">âœ•</button>
            <h2 id="formTitle" class="font-bold text-xl text-center text-pink-500 mb-6">ç™»éŒ²</h2>
            <form id="vForm" class="grid gap-4">
                <input type="text" id="inputName" placeholder="é…ä¿¡è€…å" class="w-full p-3 bg-gray-50 border-none rounded-2xl outline-none" required>
                <input type="url" id="inputUrl" placeholder="Xï¼ˆæ—§Twitterï¼‰ãƒã‚¹ãƒˆã®URL" class="w-full p-3 bg-gray-50 border-none rounded-2xl outline-none" required>
                <div id="streamFields" class="grid grid-cols-2 gap-2">
                    <input type="date" id="inputDate" class="p-3 bg-gray-50 rounded-2xl outline-none text-xs">
                    <input type="time" id="inputTime" class="p-3 bg-gray-50 rounded-2xl outline-none text-xs">
                    <select id="inputGenre" class="col-span-2 p-3 bg-gray-50 rounded-2xl outline-none text-sm">
                        <option value="é›‘è«‡">ğŸ’¬ é›‘è«‡</option><option value="ã‚²ãƒ¼ãƒ ">ğŸ® ã‚²ãƒ¼ãƒ </option><option value="æ­Œæ ">ğŸ¤ æ­Œæ </option><option value="ãã®ä»–">ğŸ’¡ ãã®ä»–</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-pink-200">é€ä¿¡ã™ã‚‹</button>
            </form>
        </div>
    </div>

    <main class="max-w-md mx-auto px-4 mt-4">
        <div id="viewMain">
            <div id="streamList"></div>
        </div>

        <section id="viewTimeline" class="hidden">
            <div id="timelineList" class="bg-white rounded-[24px] p-5 shadow-sm border border-pink-50"></div>
        </section>

        <section id="viewOhv" class="hidden flex flex-col items-center">
            <div id="ohvStack"></div>
            <p class="text-[10px] text-gray-400 mt-2 font-bold">å¿œæ´ã™ã‚‹ â¡ / èˆˆå‘³ãªã— â¬…</p>
        </section>

        <section id="viewZukan" class="hidden">
            <div id="zukanList" class="zukan-grid"></div>
        </section>
    </main>

    <div id="cheerTray" class="cheer-tray no-scrollbar">
        <button class="tag-btn" onclick="cheerV('ã‚«ãƒ¯ãƒœ')">ã‚«ãƒ¯ãƒœ ğŸ€</button>
        <button class="tag-btn" onclick="cheerV('ã‚¤ã‚±ãƒœ')">ã‚¤ã‚±ãƒœ âœ¨</button>
        <button class="tag-btn" onclick="cheerV('ãŠå§‰ã•ã‚“')">ãŠå§‰ã•ã‚“ ğŸ’„</button>
        <button class="tag-btn" onclick="cheerV('ãƒã‚¹ã‚­ãƒ¼')">ãƒã‚¹ã‚­ãƒ¼ ğŸ™ï¸</button>
        <button class="tag-btn" onclick="cheerV('è½ã¡ç€ã„ãŸ')">è½ã¡ç€ã„ãŸ â˜•ï¸</button>
        <button class="tag-btn" onclick="cheerV('è³‘ã‚„ã‹')">è³‘ã‚„ã‹ âš¡ï¸</button>
        <button class="tag-btn bg-gray-100 border-none text-gray-400" onclick="cancelV()">ãƒ‘ã‚¹ ğŸ’¨</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw5zrtCgsZDoX3dZ6Dvup_X3Ej2-GNO5Gr8UzLUsTEi8idPnW--1bU4bZ4KcSAMiZcH/exec";
        let allData = [];
        let ohvQueue = [];
        let currentType = 'stream';

        async function fetchData() {
            const res = await fetch(`${GAS_URL}?t=${Date.now()}`);
            allData = await res.json();
            renderAll();
        }

        function renderAll() {
            const today = new Date().toLocaleDateString('ja-JP', {timeZone: 'Asia/Tokyo'}).replace(/\//g, '-');
            
            // 1. é…ä¿¡ä¸€è¦§
            const streams = allData.filter(d => d.type === 'é…ä¿¡' && d.date.replace(/\//g, '-') === today).sort((a,b) => a.time.localeCompare(b.time));
            const list = document.getElementById('streamList');
            list.innerHTML = streams.length ? "" : "<p class='text-center py-20 text-gray-300 font-bold'>æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ€</p>";
            streams.forEach(d => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                list.innerHTML += `
                    <div class="stream-card">
                        <div class="card-label cat-${d.genre}">${d.time} | ${d.name}</div>
                        <div class="iframe-wrap"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}" loading="lazy"></iframe></div>
                        <a href="${d.url}" target="_blank" class="x-link cat-${d.genre}">Xã§å‘ŠçŸ¥ã‚’è¦‹ã‚‹</a>
                    </div>`;
            });

            // 2. æ™‚é–“å‰²
            const timeline = document.getElementById('timelineList');
            timeline.innerHTML = "";
            for(let h=0; h<24; h++) {
                const hourItems = streams.filter(d => parseInt(d.time.split(':')[0]) === h);
                timeline.innerHTML += `
                    <div class="flex items-start mb-4 border-b border-pink-50 pb-3">
                        <div class="w-12 font-bold text-pink-200 text-sm">${h}:00</div>
                        <div class="flex flex-wrap gap-2 flex-1">
                            ${hourItems.map(i => `<button onclick="window.open('${i.url}')" class="text-[10px] font-black px-3 py-1.5 rounded-full text-white cat-${i.genre}">${i.name}</button>`).join('') || '<span class="text-gray-100">-</span>'}
                        </div>
                    </div>`;
            }

            // 3. ãŠã¯V
            const stack = document.getElementById('ohvStack');
            ohvQueue = allData.filter(d => d.type === 'ãŠã¯V' && !d.voice).reverse();
            stack.innerHTML = ohvQueue.length ? "" : "<p class='text-center py-20 text-gray-300'>æ–°ã—ã„ãŠã¯Vã¯ã‚ã‚Šã¾ã›ã‚“ âœ¨</p>";
            ohvQueue.forEach((d, i) => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                const card = document.createElement('div');
                card.className = "v-card";
                card.style.zIndex = 100 - i;
                card.innerHTML = `<div class="v-card-top">${d.name}</div><div class="iframe-wrap"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}"></iframe></div>`;
                stack.appendChild(card);
            });

            // 4. å›³é‘‘
            const zukan = document.getElementById('zukanList');
            const rated = allData.filter(d => d.type === 'ãŠã¯V' && d.voice);
            zukan.innerHTML = rated.map(d => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                return `
                    <div class="zukan-card" onclick="window.open('${d.url}')">
                        <div class="p-2 text-center text-[10px] font-bold text-pink-400 truncate border-b">${d.name}</div>
                        <div class="iframe-wrap pointer-events-none"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}" loading="lazy"></iframe></div>
                        <div class="zukan-tags">
                            <span class="tag-badge bg-pink-100 text-pink-600">#${d.voice}</span>
                            <span class="tag-badge bg-blue-100 text-blue-600">#${d.atm}</span>
                        </div>
                    </div>`;
            }).join('');
        }

        function switchTab(t) {
            ['viewMain', 'viewTimeline', 'viewOhv', 'viewZukan'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            document.getElementById('cheerTray').classList.toggle('open', t === 'ohv' && ohvQueue.length > 0);
        }

        async function cheerV(tag) {
            const target = ohvQueue[0];
            const card = document.querySelector('.v-card:last-child');
            if(card) { card.style.transform = "translateX(200%) rotate(30deg)"; card.style.opacity = "0"; setTimeout(()=>card.remove(), 400); }
            ohvQueue.shift();
            if(ohvQueue.length === 0) document.getElementById('cheerTray').classList.remove('open');
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "rate", url: target.url, voice: tag, atm: "å¿œæ´" }) });
            fetchData();
        }

        function cancelV() {
            const card = document.querySelector('.v-card:last-child');
            if(card) { card.style.transform = "translateX(-200%) rotate(-30deg)"; card.style.opacity = "0"; setTimeout(()=>card.remove(), 400); }
            ohvQueue.shift();
            if(ohvQueue.length === 0) document.getElementById('cheerTray').classList.remove('open');
        }

        function showForm(type) { currentType = type; document.getElementById('modalForm').classList.remove('hidden'); document.getElementById('streamFields').classList.toggle('hidden', type === 'ohv'); }
        function hideForm() { document.getElementById('modalForm').classList.add('hidden'); }

        document.getElementById('vForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = { type: currentType === 'stream' ? 'é…ä¿¡' : 'ãŠã¯V', name: document.getElementById('inputName').value, url: document.getElementById('inputUrl').value, date: document.getElementById('inputDate').value || "", time: document.getElementById('inputTime').value || "", genre: document.getElementById('inputGenre').value || "" };
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            alert("ç™»éŒ²å®Œäº†ï¼"); hideForm(); fetchData();
        }

        window.onload = fetchData;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš†ã§ä½œã‚‹Vå›³é‘‘ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <style>
        :root { --v-pink: #ff85a2; --v-blue: #0095ff; --v-orange: #ff9900; --v-purple: #a855f7; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #fff5f7; color: #333; margin: 0; }
        
        /* ç™»éŒ²ã‚¨ãƒªã‚¢ï¼šæœ€ä¸Šéƒ¨ */
        .add-area { background: white; border-bottom: 3px solid var(--v-pink); padding: 10px; position: sticky; top: 0; z-index: 150; }
        .add-btn { flex: 1; padding: 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; text-align: center; border: none; cursor: pointer; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-bar { display: flex; gap: 8px; padding: 10px; overflow-x: auto; background: #fff5f7; }
        .nav-btn { flex-shrink: 0; padding: 6px 14px; border-radius: 999px; font-size: 0.8rem; font-weight: bold; color: var(--v-pink); background: white; border: 2px solid var(--v-pink); cursor: pointer; }
        .nav-btn.active { background: var(--v-pink); color: white; }

        /* é…ä¿¡ã‚«ãƒ¼ãƒ‰ï¼šã‚µã‚¤ã‚ºæœ€é©åŒ– */
        .stream-card { background: white; border-radius: 20px; overflow: hidden; border: 2px solid #ffdeeb; height: 420px; display: flex; flex-direction: column; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .card-header { padding: 8px; color: white; font-weight: bold; text-align: center; font-size: 0.85rem; }
        .iframe-container { flex: 1; overflow-y: auto; background: white; -webkit-overflow-scrolling: touch; }
        .iframe-container iframe { width: 100%; height: 500px; transform: scale(0.95); transform-origin: top center; border: none; }
        .x-btn { padding: 10px; text-align: center; color: white; font-weight: bold; font-size: 0.8rem; text-decoration: none; }

        /* ãŠã¯Vã‚¹ãƒ¯ã‚¤ãƒ— */
        #ohvStack { position: relative; height: 440px; width: 100%; max-width: 340px; margin: 10px auto; }
        .v-card { position: absolute; width: 100%; height: 100%; background: white; border-radius: 24px; border: 2px solid #ffdeeb; box-shadow: 0 10px 25px rgba(0,0,0,0.08); transition: transform 0.4s, opacity 0.4s; overflow: hidden; }
        .v-card-cover { position: absolute; inset: 0; z-index: 10; }

        /* è©•ä¾¡ãƒ‘ãƒãƒ« */
        .cheer-tray { display: flex; gap: 8px; overflow-x: auto; padding: 12px; background: white; border-top: 4px solid var(--v-pink); position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: 0.3s; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .cheer-tray.open { transform: translateY(0); }
        .tag-chip { flex-shrink: 0; padding: 8px 15px; border-radius: 12px; border: 2px solid var(--v-pink); color: var(--v-pink); font-size: 0.75rem; font-weight: bold; background: white; }

        /* å›³é‘‘ï¼šã‚¨ãƒ©ãƒ¼ä¿®æ­£ç®‡æ‰€ */
        .zukan-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .zukan-card { background: white; border-radius: 15px; border: 1px solid #ffdeeb; height: 300px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }

        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* ã‚«ãƒ†ã‚´ãƒªè‰² */
        .cat-é›‘è«‡ { background-color: var(--v-blue); }
        .cat-ã‚²ãƒ¼ãƒ  { background-color: var(--v-orange); }
        .cat-æ­Œæ  { background-color: var(--v-pink); }
        .cat-ãã®ä»– { background-color: var(--v-purple); }
    </style>
</head>
<body class="pb-20">

    <div class="add-area flex gap-2">
        <button onclick="showForm('stream')" class="add-btn bg-blue-500 shadow-sm">ï¼‹ é…ä¿¡äºˆå®š</button>
        <button onclick="showForm('ohv')" class="add-btn bg-orange-500 shadow-sm">ï¼‹ ãŠã¯V</button>
    </div>

    <div id="modalForm" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative shadow-2xl">
            <button onclick="hideForm()" class="absolute top-4 right-4 text-gray-300 font-bold text-xl">âœ•</button>
            <h2 id="formTitle" class="font-bold text-pink-500 mb-4 text-center">ç™»éŒ²</h2>
            <form id="vForm" class="grid gap-3">
                <input type="text" id="inputName" placeholder="åå‰" class="p-3 border-2 border-pink-50 rounded-xl outline-none text-sm" required>
                <input type="url" id="inputUrl" placeholder="Xãƒã‚¹ãƒˆã®URL" class="p-3 border-2 border-pink-50 rounded-xl outline-none text-sm" required>
                <div id="streamFields" class="grid grid-cols-2 gap-2">
                    <input type="date" id="inputDate" class="p-3 border-2 border-pink-50 rounded-xl outline-none text-xs">
                    <input type="time" id="inputTime" class="p-3 border-2 border-pink-50 rounded-xl outline-none text-xs">
                    <select id="inputGenre" class="col-span-2 p-3 border-2 border-pink-50 rounded-xl outline-none text-sm">
                        <option value="é›‘è«‡">ğŸ’¬ é›‘è«‡</option>
                        <option value="ã‚²ãƒ¼ãƒ ">ğŸ® ã‚²ãƒ¼ãƒ </option>
                        <option value="æ­Œæ ">ğŸ¤ æ­Œæ </option>
                        <option value="ãã®ä»–">ğŸ’¡ ãã®ä»–</option>
                    </select>
                </div>
                <button type="submit" class="bg-pink-500 text-white font-bold py-3 rounded-xl mt-2 hover:bg-pink-600 transition">ç™»éŒ²ã™ã‚‹</button>
            </form>
        </div>
    </div>

    <div class="max-w-md mx-auto px-2">
        <header>
            <nav class="nav-bar no-scrollbar">
                <button id="tabMain" class="nav-btn active" onclick="switchTab('main')">é…ä¿¡ä¸€è¦§</button>
                <button id="tabTimeline" class="nav-btn" onclick="switchTab('timeline')">æ™‚é–“å‰²</button>
                <button id="tabOhv" class="nav-btn" onclick="switchTab('ohv')">ä»Šæ—¥ã®ãŠã¯V</button>
                <button id="tabZukan" class="nav-btn" onclick="switchTab('zukan')">çš†ã§ä½œã‚‹Vå›³é‘‘</button>
            </nav>
        </header>

        <main id="viewMain" class="mt-2">
            <div id="streamList"></div>
        </main>

        <section id="viewTimeline" class="hidden mt-2">
            <div id="timelineList" class="bg-white rounded-3xl p-4 shadow-sm border border-pink-100"></div>
        </section>

        <section id="viewOhv" class="hidden flex flex-col items-center">
            <div id="ohvStack"></div>
            <p class="text-[10px] text-gray-400 mt-2">ã‚¹ãƒ¯ã‚¤ãƒ—ã§æ¬¡ã¸ / çŸ¥ã£ã¦ã‚‹äººã¯å¿œæ´ï¼</p>
        </section>

        <section id="viewZukan" class="hidden mt-2">
            <div id="zukanList" class="zukan-grid"></div>
        </section>
    </div>

    <div id="cheerTray" class="cheer-tray no-scrollbar">
        <button class="tag-chip" onclick="cheerV('ã‚«ãƒ¯ãƒœ')">ã‚«ãƒ¯ãƒœ ğŸ€</button>
        <button class="tag-chip" onclick="cheerV('ã‚¤ã‚±ãƒœ')">ã‚¤ã‚±ãƒœ âœ¨</button>
        <button class="tag-chip" onclick="cheerV('ãŠå§‰ã•ã‚“')">ãŠå§‰ã•ã‚“ ğŸ’„</button>
        <button class="tag-chip" onclick="cheerV('ãƒã‚¹ã‚­ãƒ¼')">ãƒã‚¹ã‚­ãƒ¼ ğŸ™ï¸</button>
        <button class="tag-chip" onclick="cheerV('è³‘ã‚„ã‹')">è³‘ã‚„ã‹ âš¡ï¸</button>
        <button class="tag-chip" onclick="cheerV('ç™’ã‚„ã—')">ç™’ã‚„ã— ğŸŒ™</button>
        <button class="tag-chip bg-gray-50 border-gray-200 text-gray-400" onclick="cancelV()">ãƒ‘ã‚¹ ğŸ’¨</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw5zrtCgsZDoX3dZ6Dvup_X3Ej2-GNO5Gr8UzLUsTEi8idPnW--1bU4bZ4KcSAMiZcH/exec";
        let allData = [];
        let ohvQueue = [];
        let currentSubmitType = 'stream';

        async function fetchData() {
            const res = await fetch(`${GAS_URL}?t=${Date.now()}`);
            allData = await res.json();
            renderAll();
            if(window.twttr) twttr.widgets.load();
        }

        function renderAll() {
            const jstToday = new Date().toLocaleDateString('ja-JP', {timeZone: 'Asia/Tokyo'}).replace(/\//g, '-');
            
            // é…ä¿¡ä¸€è¦§
            const streams = allData.filter(d => d.type === 'é…ä¿¡' && d.date.replace(/\//g, '-') === jstToday).sort((a,b) => a.time.compare(b.time));
            const list = document.getElementById('streamList');
            list.innerHTML = streams.length ? "" : "<p class='text-center py-20 text-gray-400 text-sm'>æœ¬æ—¥ã®é…ä¿¡äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            streams.forEach(d => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                list.innerHTML += `
                    <div class="stream-card">
                        <div class="card-header cat-${d.genre}">${d.time} | ${d.name}</div>
                        <div class="iframe-container"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}" loading="lazy"></iframe></div>
                        <a href="${d.url}" target="_blank" class="x-btn cat-${d.genre}">Xã§è©³ã—ãè¦‹ã‚‹</a>
                    </div>`;
            });

            // æ™‚é–“å‰²
            const timeline = document.getElementById('timelineList');
            timeline.innerHTML = "";
            for(let h=0; h<24; h++) {
                const hourItems = streams.filter(d => parseInt(d.time.split(':')[0]) === h);
                timeline.innerHTML += `
                    <div class="flex items-start mb-3 border-b border-pink-50 pb-2">
                        <div class="w-10 font-bold text-pink-300 text-xs">${h}:00</div>
                        <div class="flex-1 flex flex-wrap gap-1.5">
                            ${hourItems.map(i => `<button onclick="window.open('${i.url}')" class="text-[10px] font-bold px-2 py-1 rounded-full text-white cat-${i.genre}">${i.name}</button>`).join('') || '<span class="text-gray-100">-</span>'}
                        </div>
                    </div>`;
            }

            // ãŠã¯Vï¼ˆæœªè©•ä¾¡ã®ã¿ï¼‰
            const stack = document.getElementById('ohvStack');
            ohvQueue = allData.filter(d => d.type === 'ãŠã¯V' && !d.voice).reverse();
            stack.innerHTML = ohvQueue.length ? "" : "<p class='text-center py-20 text-gray-400'>æ–°ã—ã„ãƒã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            ohvQueue.forEach((d, i) => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                const card = document.createElement('div');
                card.className = "v-card";
                card.style.zIndex = 100 - i;
                card.innerHTML = `
                    <div class="p-2 text-center font-bold text-orange-400 border-b text-sm">${d.name}</div>
                    <div class="iframe-container"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}"></iframe></div>
                    <div class="v-card-cover" onclick="window.open('${d.url}')"></div>`;
                stack.appendChild(card);
            });

            // å›³é‘‘
            const zukan = document.getElementById('zukanList');
            const rated = allData.filter(d => d.type === 'ãŠã¯V' && d.voice);
            zukan.innerHTML = rated.map(d => {
                const tid = d.url.split('/status/')[1]?.split('?')[0];
                return `
                    <div class="zukan-card">
                        <div class="p-2 text-center text-[10px] font-bold text-pink-500 truncate border-b">${d.name}</div>
                        <div class="iframe-container pointer-events-none"><iframe src="https://platform.twitter.com/embed/Tweet.html?id=${tid}" loading="lazy"></iframe></div>
                        <div class="p-2 flex gap-1 flex-wrap overflow-hidden">
                            <span class="text-[8px] bg-pink-50 text-pink-600 px-1.5 py-0.5 rounded-full font-bold">#${d.voice}</span>
                            <span class="text-[8px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full font-bold">#${d.atm}</span>
                        </div>
                    </div>`;
            }).join('');
        }

        function switchTab(t) {
            ['viewMain', 'viewTimeline', 'viewOhv', 'viewZukan'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            document.getElementById('cheerTray').classList.toggle('open', t === 'ohv' && ohvQueue.length > 0);
        }

        async function cheerV(tag) {
            const target = ohvQueue[0];
            const card = document.querySelector('.v-card:last-child');
            if(card) { card.style.transform = "translateX(150%) rotate(20deg)"; card.style.opacity = "0"; setTimeout(()=>card.remove(), 400); }
            ohvQueue.shift();
            if(ohvQueue.length === 0) document.getElementById('cheerTray').classList.remove('open');
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "rate", url: target.url, voice: tag, atm: "å¿œæ´" }) });
            fetchData();
        }

        function cancelV() {
            const card = document.querySelector('.v-card:last-child');
            if(card) { card.style.transform = "translateX(-150%) rotate(-20deg)"; card.style.opacity = "0"; setTimeout(()=>card.remove(), 400); }
            ohvQueue.shift();
            if(ohvQueue.length === 0) document.getElementById('cheerTray').classList.remove('open');
        }

        function showForm(type) {
            currentSubmitType = type;
            document.getElementById('modalForm').classList.remove('hidden');
            document.getElementById('formTitle').innerText = type === 'stream' ? 'é…ä¿¡äºˆå®šã‚’ç™»éŒ²' : 'ãŠã¯Vã‚’ç™»éŒ²';
            document.getElementById('streamFields').classList.toggle('hidden', type === 'ohv');
        }
        function hideForm() { document.getElementById('modalForm').classList.add('hidden'); }

        document.getElementById('vForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                type: currentSubmitType === 'stream' ? 'é…ä¿¡' : 'ãŠã¯V',
                name: document.getElementById('inputName').value,
                url: document.getElementById('inputUrl').value,
                date: document.getElementById('inputDate').value || "",
                time: document.getElementById('inputTime').value || "",
                genre: document.getElementById('inputGenre').value || ""
            };
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            alert("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
            hideForm();
            fetchData();
        }

        window.onload = fetchData;
    </script>
</body>
</html>